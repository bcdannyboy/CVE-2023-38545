#!/bin/bash

# Check if the script is run as root
if [ "$EUID" -ne 0 ]; then
  echo "Please run as root"
  exit 1
fi

# Update package list
apt update

# Install Dante server if not already installed
if ! dpkg -l | grep -q "dante-server"; then
  apt install -y dante-server
else
  echo "Dante server is already installed. Overwriting the config file."
fi

# Create Dante log file if it doesn't exist
if [ ! -f /var/log/danted.log ]; then
  touch /var/log/danted.log
fi

# Set permissions for the log file
chmod 644 /var/log/danted.log
chown nobody:nogroup /var/log/danted.log

# Get the first IP address of the server
HOSTNAME=$(hostname -I | awk '{print $1}')

# Create or overwrite Dante configuration file
cat <<EOL > /etc/danted.conf
logoutput: /var/log/danted.log
internal: 0.0.0.0 port = 1080
external: $HOSTNAME
method: username none
user.privileged: proxy
user.notprivileged: nobody

client pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: connect disconnect error
}

pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    command: bind connect udpassociate
    log: error
    method: none
}
EOL

# Restart Dante service to apply changes
systemctl enable danted
systemctl restart danted

# Check if Dante is running
if systemctl is-active --quiet danted; then
  echo "Dante SOCKS5 proxy is set up and running on port 1080."
else
  echo "Failed to start Dante SOCKS5 proxy. Check the system logs for more information."
fi
