#!/bin/bash

# Install Dante Server
sudo apt update
sudo apt install -y dante-server libpam-script

# Backup original config
sudo cp /etc/danted.conf /etc/danted.conf.bak

# Create a PAM script for hardcoded authentication
echo '#!/bin/bash
if [ "$PAM_USER" = "cve202338545" ] && [ "$PAM_AUTHTOK" = "poc" ]; then
    exit 0
else
    exit 1
fi' | sudo tee /etc/security/check_user.sh

# Make the PAM script executable
sudo chmod +x /etc/security/check_user.sh

# Create a PAM configuration file for Dante
echo 'auth required pam_script.so dir=/etc/security' | sudo tee /etc/pam.d/danted

# Get the active network interface
INTERFACE=$(ip route | grep default | awk '{print $5}')

# Create new Dante config
echo "logoutput: /var/log/danted.log
user.privileged: root
user.unprivileged: nobody
user.libwrap: nobody

# The listening network interface or address.
internal: 0.0.0.0 port=1080

# The proxying network interface or address.
external: $INTERFACE

method: pam none  # Enabled PAM and none as authentication methods
client pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    log: error
    method: pam none  # Added PAM and none methods here
}
pass {
    from: 0.0.0.0/0 to: 0.0.0.0/0
    command: bind connect udpassociate
    log: error
    method: pam none  # Added PAM and none methods here
}" | sudo tee /etc/danted.conf

# Restart Dante server
sudo systemctl restart danted

# Added log file permission change
sudo touch /var/log/danted.log
sudo chmod 644 /var/log/danted.log

# Restart Dante server
sudo systemctl restart danted

echo "Dante SOCKS5 proxy with hardcoded credentials is set up on port 1080."
